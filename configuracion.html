<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Addocu Brand Colors */
      --addocu-blue-primary: #1A5DBB;
      --addocu-blue-light: #00AEEF;
      --addocu-green: #4CAF50;
      --addocu-green-light: #8BC34A;
      --addocu-bg: #FAFAFA;
      --addocu-text-primary: #1A1A1A;
      --addocu-text-secondary: #666666;
      --addocu-text-muted: #999999;
      --addocu-border: #E1E1E1;
      --addocu-border-light: #F0F0F0;
      --addocu-white: #FFFFFF;
      --addocu-gradient: linear-gradient(135deg, var(--addocu-blue-primary), var(--addocu-blue-light));
      --addocu-future: linear-gradient(135deg, #8B5CF6, #A78BFA);
    }

    * {
      box-sizing: border-box;
    }

    body { 
      padding: 0; 
      margin: 0; 
      font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--addocu-bg);
      color: var(--addocu-text-primary);
      line-height: 1.5;
      overflow: hidden;
    }
    
    .sidebar-container {
      height: 100vh;
      overflow-y: auto;
      background: var(--addocu-white);
      width: 100%;
      max-width: 380px;
    }
    
    /* Header */
    .header {
      padding: 32px 24px 24px;
      border-bottom: 1px solid var(--addocu-border-light);
    }
    
    .logo {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      background: var(--addocu-gradient);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 600;
      color: var(--addocu-text-primary);
      letter-spacing: -0.3px;
    }
    
    .tagline {
      font-size: 14px;
      color: var(--addocu-text-secondary);
      font-weight: 400;
      margin: 0;
    }

    /* Content */
    .content {
      padding: 24px;
    }

    /* Section */
    .section {
      margin-bottom: 32px;
    }

    .section:last-child {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--addocu-text-primary);
      margin: 0 0 16px 0;
    }

    .section-description {
      font-size: 14px;
      color: var(--addocu-text-secondary);
      margin: 0 0 20px 0;
      line-height: 1.4;
    }

    /* Status Steps */
    .status-steps {
      margin-bottom: 24px;
    }

    .step {
      display: flex;
      align-items: center;
      padding: 12px 0;
    }

    .step-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--addocu-border);
      border: 2px solid var(--addocu-border);
      margin-right: 12px;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .step.completed .step-indicator {
      background: var(--addocu-green);
      border-color: var(--addocu-green);
    }

    .step.completed .step-indicator::after {
      content: 'âœ“';
      color: white;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .step-text {
      font-size: 14px;
      color: var(--addocu-text-primary);
      font-weight: 400;
    }

    .step.completed .step-text {
      color: var(--addocu-text-secondary);
    }

    /* Input Groups */
    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--addocu-text-primary);
      margin-bottom: 8px;
    }

    .input-field {
      position: relative;
    }

    .input-field input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--addocu-border);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: var(--addocu-white);
      transition: all 0.2s ease;
    }

    .input-field input:focus {
      outline: none;
      border-color: var(--addocu-blue-primary);
      box-shadow: 0 0 0 3px rgba(26, 93, 187, 0.08);
    }

    .input-field input::placeholder {
      color: var(--addocu-text-muted);
    }

    .input-help {
      font-size: 13px;
      color: var(--addocu-text-secondary);
      margin-top: 6px;
      line-height: 1.4;
    }

    .input-help a {
      color: var(--addocu-blue-primary);
      text-decoration: none;
    }

    .input-help a:hover {
      text-decoration: underline;
    }

    /* Connection Status */
    .connection-status {
      background: var(--addocu-bg);
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }

    .connection-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
    }

    .connection-item:first-child {
      padding-top: 0;
    }

    .connection-item:last-child {
      padding-bottom: 0;
    }

    .connection-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .indicator-pending { background: var(--addocu-text-muted); }
    .indicator-success { background: var(--addocu-green); }
    .indicator-error { background: #DC2626; }

    .connection-name {
      font-size: 14px;
      font-weight: 400;
      color: var(--addocu-text-primary);
    }

    .connection-details {
      font-size: 13px;
      color: var(--addocu-text-secondary);
      margin-top: 2px;
    }

    /* Service Selection */
    .service-grid {
      display: grid;
      gap: 8px;
    }

    .service-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--addocu-bg);
      border: 1px solid var(--addocu-border-light);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .service-item:hover {
      border-color: var(--addocu-border);
    }

    .service-info {
      flex: 1;
    }

    .service-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--addocu-text-primary);
      margin-bottom: 2px;
    }

    .service-description {
      font-size: 13px;
      color: var(--addocu-text-secondary);
    }

    /* Advanced Filters */
    .filters-container {
      background: var(--addocu-bg);
      border: 1px solid var(--addocu-border-light);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .filters-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .filters-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--addocu-text-primary);
    }

    .filters-toggle {
      background: none;
      border: none;
      color: var(--addocu-blue-primary);
      font-size: 13px;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    .filters-content {
      display: none;
    }

    .filters-content.expanded {
      display: block;
    }

    .filter-grid {
      display: grid;
      gap: 16px;
    }

    .filter-example {
      background: var(--addocu-white);
      border: 1px solid var(--addocu-border-light);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--addocu-text-muted);
      margin-top: 4px;
    }

    /* Toggle Switch */
    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--addocu-border);
      transition: 0.2s ease;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background: white;
      transition: 0.2s ease;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .toggle input:checked + .toggle-slider {
      background: var(--addocu-blue-primary);
    }

    .toggle input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    /* Buttons */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      border: none;
      width: 100%;
    }

    .btn-primary {
      background: var(--addocu-gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(26, 93, 187, 0.25);
    }

    .btn-secondary {
      background: var(--addocu-white);
      border: 1px solid var(--addocu-border);
      color: var(--addocu-text-primary);
    }

    .btn-secondary:hover {
      background: var(--addocu-bg);
      border-color: var(--addocu-blue-primary);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .btn-full {
      grid-column: 1 / -1;
    }

    /* Future Features */
    .future-section {
      background: linear-gradient(135deg, #F8F4FF, #F3F1FF);
      border: 1px solid #E5E2FF;
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .future-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .future-icon {
      width: 20px;
      height: 20px;
      background: var(--addocu-future);
      border-radius: 4px;
      margin-right: 8px;
      font-size: 12px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .future-title {
      font-size: 15px;
      font-weight: 600;
      color: #6B46C1;
      margin: 0;
    }

    .future-description {
      font-size: 13px;
      color: var(--addocu-text-secondary);
      margin: 0 0 16px 0;
      line-height: 1.4;
    }

    .future-list {
      display: grid;
      gap: 8px;
    }

    .future-item {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: var(--addocu-text-primary);
    }

    .future-bullet {
      width: 4px;
      height: 4px;
      background: #8B5CF6;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }

    /* Status Messages */
    .status-message {
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 14px;
      line-height: 1.4;
      border-left: 3px solid;
    }

    .status-success {
      background: #F0F9F0;
      border-color: var(--addocu-green);
      color: #166534;
    }

    .status-error {
      background: #FEF2F2;
      border-color: #DC2626;
      color: #991B1B;
    }

    .status-warning {
      background: #FFFBEB;
      border-color: #F59E0B;
      color: #92400E;
    }

    .status-info {
      background: #EFF6FF;
      border-color: var(--addocu-blue-light);
      color: #1E40AF;
    }

    /* Loading */
    .loading {
      display: inline-flex;
      align-items: center;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Fade animation */
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(4px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    /* Responsive */
    @media (max-width: 400px) {
      .content {
        padding: 20px;
      }
      
      .btn-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar-container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-icon">A</div>
        <span class="logo-text">Addocu</span>
      </div>
      <p class="tagline">Audit and Document Your Google Marketing Stack in Seconds</p>
    </div>

    <div class="content">
      <!-- Setup Progress -->
      <div class="section">
        <div class="section-title">Setup Progress</div>
        <div class="status-steps">
          <div class="step completed" id="step-oauth">
            <div class="step-indicator"></div>
            <div class="step-text">OAuth authorization ready</div>
          </div>
          <div class="step" id="step-connection">
            <div class="step-indicator"></div>
            <div class="step-text">Test API connections</div>
          </div>
          <div class="step" id="step-audit">
            <div class="step-indicator"></div>
            <div class="step-text">Run first audit</div>
          </div>
        </div>
      </div>

      <!-- Authentication -->
      <div class="section">
        <div class="section-title">Authentication</div>
        <div class="section-description">
          All services work with OAuth2 authorization (automatic). No API keys required.
        </div>

        <div class="input-group" style="display: none;">
          <label class="input-label">Looker Studio API Key (Legacy - Not Required)</label>
          <div class="input-field">
            <input 
              type="password" 
              id="api-key" 
              placeholder="Not needed - OAuth2 is used automatically" 
              autocomplete="off"
              disabled
            >
          </div>
          <div class="input-help">
            Looker Studio now uses OAuth2 authentication automatically. No API key required.
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="testConnection()">
            Test Connection
          </button>
          <button class="btn btn-primary" onclick="saveConfiguration()">
            Save Configuration
          </button>
        </div>
      </div>

      <!-- Connection Status -->
      <div class="section" id="connection-section" style="display: none;">
        <div class="section-title">Connection Status</div>
        <div class="connection-status">
          <div class="connection-item">
            <div class="connection-indicator indicator-pending" id="ga4-indicator"></div>
            <div>
              <div class="connection-name">Google Analytics 4</div>
              <div class="connection-details" id="ga4-status">OAuth2 automatic</div>
            </div>
          </div>
          <div class="connection-item">
            <div class="connection-indicator indicator-pending" id="gtm-indicator"></div>
            <div>
              <div class="connection-name">Google Tag Manager</div>
              <div class="connection-details" id="gtm-status">OAuth2 automatic</div>
            </div>
          </div>
          <div class="connection-item">
            <div class="connection-indicator indicator-pending" id="looker-indicator"></div>
            <div>
              <div class="connection-name">Looker Studio</div>
              <div class="connection-details" id="looker-status">OAuth2 automatic</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Services -->
      <div class="section">
        <div class="section-title">Services to Audit</div>
        <div class="service-grid">
          <div class="service-item">
            <div class="service-info">
              <div class="service-name">Google Analytics 4</div>
              <div class="service-description">Properties, dimensions, metrics, data streams</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="service-ga4" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="service-item">
            <div class="service-info">
              <div class="service-name">Google Tag Manager</div>
              <div class="service-description">Tags, triggers, variables, workspaces</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="service-gtm" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="service-item">
            <div class="service-info">
              <div class="service-name">Looker Studio</div>
              <div class="service-description">Reports, data sources, permissions</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="service-looker" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div class="filters-container">
          <div class="filters-header">
            <span class="filters-title">Advanced Filters</span>
            <button class="filters-toggle" onclick="toggleFilters()">
              <span id="filters-toggle-text">Show filters</span>
            </button>
          </div>
          <div class="filters-content" id="filters-content">
            <div class="filter-grid">
              <div class="input-group">
                <label class="input-label">GA4 Properties (Optional)</label>
                <div class="input-field">
                  <input 
                    type="text" 
                    id="ga4-properties" 
                    placeholder="properties/123456789, properties/987654321"
                  >
                </div>
                <div class="input-help">
                  Specific property IDs to audit. Leave empty to audit all accessible properties.
                </div>
                <div class="filter-example">
                  Example: properties/123456789, properties/987654321
                </div>
              </div>

              <div class="input-group">
                <label class="input-label">GTM Workspaces (Optional)</label>
                <div class="input-field">
                  <input 
                    type="text" 
                    id="gtm-workspaces" 
                    placeholder="Default Workspace, Marketing Team"
                  >
                </div>
                <div class="input-help">
                  Specific workspace names to audit. Leave empty to audit all workspaces.
                </div>
                <div class="filter-example">
                  Example: Default Workspace, Marketing Team, Development
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="section">
        <div class="section-title">Run Audit</div>
        <button class="btn btn-primary btn-full" onclick="runAudit()" id="audit-button">
          Audit Marketing Stack
        </button>

        <!-- Future Features -->
        <div class="future-section">
          <div class="future-header">
            <div class="future-icon">â˜…</div>
            <h4 class="future-title">Pro Version Coming Soon</h4>
          </div>
          <p class="future-description">
            We're working on advanced features to make Addocu even more powerful for professional teams.
          </p>
          <div class="future-list">
            <div class="future-item">
              <div class="future-bullet"></div>
              <span>BigQuery integration for data warehouse audits</span>
            </div>
            <div class="future-item">
              <div class="future-bullet"></div>
              <span>Google Ads campaigns and conversion tracking</span>
            </div>
            <div class="future-item">
              <div class="future-bullet"></div>
              <span>AI-powered analysis and optimization suggestions</span>
            </div>
            <div class="future-item">
              <div class="future-bullet"></div>
              <span>Scheduled audits and automated monitoring</span>
            </div>
            <div class="future-item">
              <div class="future-bullet"></div>
              <span>Google Search Console performance insights</span>
            </div>
            <div class="future-item">
              <div class="future-bullet"></div>
              <span>Multi-team collaboration and permissions</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="status-messages"></div>
    </div>
  </div>

  <script>
    // ========================================
    // STATE MANAGEMENT
    // ========================================
    
    let appState = {
      apiKey: '',
      connectionStatus: {
        ga4: 'pending',
        gtm: 'pending', 
        looker: 'pending'
      },
      services: {
        ga4: true,
        gtm: true,
        looker: true
      },
      filters: {
        ga4Properties: '',
        gtmWorkspaces: ''
      }
    };

    // ========================================
    // INITIALIZATION
    // ========================================
    
    document.addEventListener('DOMContentLoaded', function() {
      loadConfiguration();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Service toggles
      document.getElementById('service-ga4').addEventListener('change', updateServices);
      document.getElementById('service-gtm').addEventListener('change', updateServices);
      document.getElementById('service-looker').addEventListener('change', updateServices);
      
      // Filter inputs
      document.getElementById('ga4-properties').addEventListener('input', updateFilters);
      document.getElementById('gtm-workspaces').addEventListener('input', updateFilters);
    }

    function loadConfiguration() {
      showStatus('Loading configuration...', 'info');
      
      google.script.run
        .withSuccessHandler(function(config) {
          if (config && config.lookerApiKey) {
            appState.apiKey = config.lookerApiKey;
            document.getElementById('api-key').value = config.lookerApiKey;
          }
          
          // Load saved filters
          if (config && config.ga4Properties) {
            appState.filters.ga4Properties = config.ga4Properties;
            document.getElementById('ga4-properties').value = config.ga4Properties;
          }
          
          if (config && config.gtmWorkspaces) {
            appState.filters.gtmWorkspaces = config.gtmWorkspaces;
            document.getElementById('gtm-workspaces').value = config.gtmWorkspaces;
          }
          
          hideStatus();
          // Auto-test connection
          setTimeout(() => testConnection(), 1000);
        })
        .withFailureHandler(function(error) {
          showStatus(`Error loading configuration: ${error.message}`, 'error');
        })
        .getUserConfig();
    }

    // ========================================
    // FILTERS MANAGEMENT
    // ========================================
    
    function toggleFilters() {
      const content = document.getElementById('filters-content');
      const toggleText = document.getElementById('filters-toggle-text');
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        toggleText.textContent = 'Show filters';
      } else {
        content.classList.add('expanded');
        toggleText.textContent = 'Hide filters';
      }
    }

    function updateFilters() {
      appState.filters.ga4Properties = document.getElementById('ga4-properties').value.trim();
      appState.filters.gtmWorkspaces = document.getElementById('gtm-workspaces').value.trim();
    }

    function parseCommaSeparatedValues(input) {
      if (!input) return [];
      return input.split(',')
        .map(item => item.trim())
        .filter(item => item.length > 0);
    }

    // ========================================
    // CONFIGURATION
    // ========================================
    
    function saveConfiguration() {
      const apiKey = document.getElementById('api-key').value.trim();
      
      // API key validation no longer needed for OAuth2-only setup
      // Legacy support maintained for backwards compatibility
      
      updateFilters();
      showButtonLoading('audit-button', 'Saving configuration...');
      
      const config = {
        lookerApiKey: apiKey,
        ga4Properties: appState.filters.ga4Properties,
        gtmWorkspaces: appState.filters.gtmWorkspaces
      };
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            appState.apiKey = apiKey;
            showStatus('Configuration saved (OAuth2 ready for all services)', 'success');
            
            // Auto-test after save
            setTimeout(() => testConnection(), 1000);
          } else {
            showStatus(`Error: ${response.error}`, 'error');
          }
          hideButtonLoading('audit-button', 'Audit Marketing Stack');
        })
        .withFailureHandler(function(error) {
          showStatus(`Error saving: ${error.message}`, 'error');
          hideButtonLoading('audit-button', 'Audit Marketing Stack');
        })
        .guardarConfiguracionUsuario(config);
    }

    // ========================================
    // CONNECTION TESTING
    // ========================================
    
    function testConnection() {
      document.getElementById('connection-section').style.display = 'block';
      
      // Reset indicators
      resetConnectionStatus();
      showStatus('Testing API connections...', 'info');
      
      google.script.run
        .withSuccessHandler(function(results) {
          updateConnectionResults(results);
          updateStepStatus('connection', true);
          
          const hasErrors = results.some(r => {
            const estado = Array.isArray(r) ? r[2] : r.estado;
            return estado !== 'OK';
          });
          
          if (!hasErrors) {
            showStatus('All connections working correctly', 'success');
          } else {
            showStatus('Some services need configuration', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          showStatus(`Connection test failed: ${error.message}`, 'error');
          resetConnectionStatus();
        })
        .diagnosticarConexionesCompleto();
    }

    function resetConnectionStatus() {
      const indicators = ['ga4-indicator', 'gtm-indicator', 'looker-indicator'];
      const statuses = ['ga4-status', 'gtm-status', 'looker-status'];
      
      indicators.forEach(id => {
        document.getElementById(id).className = 'connection-indicator indicator-pending';
      });
      
      statuses.forEach(id => {
        const element = document.getElementById(id);
        if (id === 'ga4-status' || id === 'gtm-status') {
          element.textContent = 'Testing...';
        } else if (id === 'looker-status') {
          element.textContent = 'Testing...';
        }
      });
    }

    function updateConnectionResults(results) {
      const serviceMapping = {
        'Google Analytics 4 Admin API': 'ga4',
        'Google Tag Manager API': 'gtm',
        'Looker Studio API': 'looker'
      };
      
      const formattedResults = results.map(result => {
        if (Array.isArray(result)) {
          return {
            servicio: result[0],
            cuenta: result[1],
            estado: result[2],
            mensaje: result[3]
          };
        }
        return result;
      });
      
      formattedResults.forEach(result => {
        const serviceKey = serviceMapping[result.servicio];
        if (serviceKey) {
          const indicator = document.getElementById(`${serviceKey}-indicator`);
          const status = document.getElementById(`${serviceKey}-status`);
          
          if (result.estado === 'OK') {
            indicator.className = 'connection-indicator indicator-success';
            
            // Manejo especÃ­fico para cada servicio
            if (serviceKey === 'looker') {
              status.textContent = result.cuenta === 'N/A' || result.cuenta === 'Pendiente' ? 'OAuth2 conectado' : result.cuenta;
            } else {
              status.textContent = result.cuenta || 'Connected';
            }
            
            appState.connectionStatus[serviceKey] = 'success';
          } else {
            indicator.className = 'connection-indicator indicator-error';
            status.textContent = result.mensaje || 'Connection error';
            appState.connectionStatus[serviceKey] = 'error';
          }
        }
      });
    }

    // ========================================
    // SERVICE MANAGEMENT
    // ========================================
    
    function updateServices() {
      appState.services.ga4 = document.getElementById('service-ga4').checked;
      appState.services.gtm = document.getElementById('service-gtm').checked;
      appState.services.looker = document.getElementById('service-looker').checked;
    }

    // ========================================
    // AUDIT EXECUTION
    // ========================================
    
    function runAudit() {
      updateServices();
      updateFilters();
      
      const enabledServices = Object.entries(appState.services)
        .filter(([key, value]) => value)
        .map(([key]) => key);
      
      if (enabledServices.length === 0) {
        showStatus('Select at least one service to audit', 'error');
        return;
      }
      
      showButtonLoading('audit-button', `Auditing ${enabledServices.length} services...`);
      
      // Prepare audit configuration with filters
      const auditConfig = {
        services: enabledServices,
        filters: {
          ga4Properties: parseCommaSeparatedValues(appState.filters.ga4Properties),
          gtmWorkspaces: parseCommaSeparatedValues(appState.filters.gtmWorkspaces)
        }
      };
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            updateStepStatus('audit', true);
            showStatus('Audit completed successfully', 'success');
          } else {
            showStatus(`Audit error: ${response.error}`, 'error');
          }
          hideButtonLoading('audit-button', 'Audit Marketing Stack');
        })
        .withFailureHandler(function(error) {
          showStatus(`Audit failed: ${error.message}`, 'error');
          hideButtonLoading('audit-button', 'Audit Marketing Stack');
        })
        .ejecutarAuditoriaConFiltros(auditConfig);
    }

    // ========================================
    // UI HELPERS
    // ========================================
    
    function updateStepStatus(stepId, completed) {
      const step = document.getElementById(`step-${stepId}`);
      if (completed) {
        step.classList.add('completed');
      } else {
        step.classList.remove('completed');
      }
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status-messages');
      const statusCard = document.createElement('div');
      statusCard.className = `status-message status-${type} fade-in`;
      statusCard.textContent = message;
      
      statusDiv.innerHTML = '';
      statusDiv.appendChild(statusCard);
      
      if (type === 'success') {
        setTimeout(() => {
          statusCard.style.transition = 'opacity 0.3s ease';
          statusCard.style.opacity = '0';
          setTimeout(() => statusCard.remove(), 300);
        }, 3000);
      }
    }

    function hideStatus() {
      document.getElementById('status-messages').innerHTML = '';
    }

    function showButtonLoading(buttonId, text) {
      const button = document.getElementById(buttonId);
      button.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          ${text}
        </div>
      `;
      button.disabled = true;
    }

    function hideButtonLoading(buttonId, originalText) {
      const button = document.getElementById(buttonId);
      button.innerHTML = originalText;
      button.disabled = false;
    }
  </script>
</body>
</html>