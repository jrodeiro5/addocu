<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Addocu v3.0 - Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.45.2/apexcharts.min.js"></script>
  <style>
    :root {
      /* Addocu Brand Colors - Preservados */
      --addocu-blue-primary: #1A5DBB;
      --addocu-blue-light: #00AEEF;
      --addocu-green: #4CAF50;
      --addocu-green-light: #8BC34A;
      
      /* Modern Dashboard Color System - Light Mode */
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --surface: #ffffff;
      --surface-elevated: #ffffff;
      --surface-hover: #f8fafc;
      
      /* Text Colors - Light Mode */
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-tertiary: #64748b;
      --text-accent: var(--addocu-blue-primary);
      
      /* Semantic Colors - Modern Palette */
      --success: #10b981;
      --success-bg: #ecfdf5;
      --warning: #f59e0b;
      --warning-bg: #fefce8;
      --error: #ef4444;
      --error-bg: #fef2f2;
      --info: #3b82f6;
      --info-bg: #eff6ff;
      
      /* Chart Colors - Balanced & Accessible */
      --chart-primary: var(--addocu-blue-primary);
      --chart-secondary: var(--success);
      --chart-tertiary: var(--warning);
      --chart-quaternary: #a855f7;
      --chart-quinary: #ec4899;
      --chart-senary: #06b6d4;
      
      /* Interactive Elements */
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      --border-dark: #94a3b8;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Spacing & Sizing */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    /* Dark Mode Colors */
    [data-theme="dark"] {
      /* Backgrounds - Dark Mode */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --surface: #1e293b;
      --surface-elevated: #334155;
      --surface-hover: #475569;
      
      /* Text Colors - Dark Mode (Desaturated for better readability) */
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --text-accent: #60a5fa;
      
      /* Semantic Colors - Dark Mode (Less saturated) */
      --success: #059669;
      --success-bg: #064e3b;
      --warning: #d97706;
      --warning-bg: #92400e;
      --error: #dc2626;
      --error-bg: #991b1b;
      --info: #2563eb;
      --info-bg: #1e3a8a;
      
      /* Chart Colors - Dark Mode Optimized */
      --chart-primary: #60a5fa;
      --chart-secondary: #34d399;
      --chart-tertiary: #fbbf24;
      --chart-quaternary: #c084fc;
      --chart-quinary: #f472b6;
      --chart-senary: #22d3ee;
      
      /* Interactive Elements - Dark Mode */
      --border-light: #334155;
      --border-medium: #475569;
      --border-dark: #64748b;
      
      /* Shadows - Dark Mode */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: all 0.3s ease;
      line-height: 1.5;
      font-size: 14px;
    }

    /* LOADING STATE */
    #loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: var(--bg-primary);
      transition: all 0.3s ease;
    }

    .loader-content {
      text-align: center;
      animation: fadeInScale 1s ease-out;
    }

    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .loader-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--chart-primary) 0%, var(--chart-secondary) 100%);
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin: 0 auto 24px;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: var(--shadow-lg);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: var(--shadow-lg); }
      50% { transform: scale(1.05); box-shadow: var(--shadow-xl); }
    }

    .loader-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .loader-subtext {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* HEADER - Optimizado */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border-light);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1440px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--addocu-blue-primary) 0%, var(--addocu-green) 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .logo-version {
      font-size: 12px;
      color: var(--text-tertiary);
      font-weight: 500;
      margin-left: 8px;
      padding: 2px 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .theme-toggle {
      background: var(--surface-hover);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      font-size: 16px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: var(--surface-elevated);
      color: var(--text-primary);
      transform: scale(1.05);
    }

    .action-btn {
      background: var(--chart-primary);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn.secondary {
      background: var(--success);
    }

    .action-btn.secondary:hover {
      background: #059669;
    }

    .action-btn.audit-btn {
      background: linear-gradient(135deg, var(--chart-primary) 0%, var(--chart-secondary) 100%);
      font-weight: 700;
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.2); }
    }

    /* DASHBOARD LAYOUT - Optimizado */
    #dashboard-wrapper {
      display: none;
      padding: 24px;
      max-width: 1440px;
      margin: 0 auto;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .dashboard-grid.grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    }

    .dashboard-grid.grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .dashboard-grid.grid-4 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--chart-primary) 0%, var(--chart-secondary) 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
      font-weight: 600;
    }

    /* CARDS - Sistema mejorado */
    .glass-card {
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: 24px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      animation: cardSlideIn 0.6s ease-out forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--chart-primary) 0%, var(--chart-secondary) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .glass-card:hover {
      background: var(--surface-hover);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
      border-color: var(--chart-primary);
    }

    .glass-card:hover::before {
      opacity: 1;
    }

    @keyframes cardSlideIn {
      to { opacity: 1; transform: translateY(0); }
    }

    /* KPI CARDS - Rediseñadas */
    .kpi-card {
      text-align: center;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    .kpi-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 16px;
      background: var(--chart-primary);
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      box-shadow: var(--shadow-md);
      animation: iconFloat 4s ease-in-out infinite;
    }

    @keyframes iconFloat {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-4px) rotate(1deg); }
      75% { transform: translateY(-2px) rotate(-1deg); }
    }

    .kpi-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: 'JetBrains Mono', monospace;
      animation: countUp 1.5s ease-out;
    }

    @keyframes countUp {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .kpi-trend {
      font-size: 12px;
      font-weight: 600;
      color: var(--success);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .kpi-trend.warning {
      color: var(--warning);
    }

    .kpi-trend.error {
      color: var(--error);
    }

    /* PROGRESS BARS - Modernizadas */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      overflow: hidden;
      margin-top: 12px;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--chart-primary) 0%, var(--chart-secondary) 100%);
      width: 0%;
      transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* CHARTS - Optimizados */
    .chart-card {
      min-height: 380px;
    }

    .chart-wide {
      grid-column: 1 / -1;
      min-height: 420px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-export {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chart-export:hover {
      background: var(--surface-elevated);
      color: var(--text-primary);
      border-color: var(--chart-primary);
    }

    /* STATUS GRID - Modernizada */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .status-item {
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .status-item:hover {
      background: var(--surface-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .status-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--success);
      transition: all 0.3s ease;
    }

    .status-item.warning::before {
      background: var(--warning);
    }

    .status-item.error::before {
      background: var(--error);
    }

    .status-icon {
      font-size: 24px;
      margin-bottom: 12px;
      display: block;
    }

    .status-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .status-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--success);
    }

    .status-value.warning {
      color: var(--warning);
    }

    .status-value.error {
      color: var(--error);
    }

    /* RESPONSIVE DESIGN - Mejorado */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
      }
      
      .dashboard-grid.grid-2 {
        grid-template-columns: 1fr;
      }
      
      .chart-wide {
        min-height: 360px;
      }
    }

    @media (max-width: 768px) {
      #dashboard-wrapper {
        padding: 16px;
      }
      
      .header {
        padding: 12px 16px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }
      
      .header-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .glass-card {
        padding: 16px;
      }
      
      .kpi-card {
        min-height: 140px;
      }
      
      .kpi-value {
        font-size: 28px;
      }
      
      .status-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .chart-card, .chart-wide {
        min-height: 300px;
      }
    }

    @media (max-width: 480px) {
      .action-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      .logo-text {
        font-size: 18px;
      }
      
      .status-grid {
        grid-template-columns: 1fr;
      }
    }

    /* NOTIFICATIONS - Sistema mejorado */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 14px;
      box-shadow: var(--shadow-lg);
      transform: translateX(400px);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1001;
      max-width: 320px;
      backdrop-filter: blur(10px);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 4px solid var(--success);
      background: var(--success-bg);
    }

    .notification.error {
      border-left: 4px solid var(--error);
      background: var(--error-bg);
    }

    .notification.warning {
      border-left: 4px solid var(--warning);
      background: var(--warning-bg);
    }

    /* ANIMATIONS - Suaves y modernas */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-spin {
      animation: spin 1s linear infinite;
    }

    /* UTILITY CLASSES */
    .text-center { text-align: center; }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-error { color: var(--error); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }

    .bg-success { background-color: var(--success-bg); }
    .bg-warning { background-color: var(--warning-bg); }
    .bg-error { background-color: var(--error-bg); }

    .border-success { border-color: var(--success); }
    .border-warning { border-color: var(--warning); }
    .border-error { border-color: var(--error); }

    /* TOOLTIPS */
    .tooltip {
      position: relative;
    }

    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .tooltip:hover::after {
      opacity: 1;
    }

    /* ACCESSIBILITY */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* FOCUS STYLES */
    .action-btn:focus,
    .theme-toggle:focus,
    .chart-export:focus {
      outline: 2px solid var(--chart-primary);
      outline-offset: 2px;
    }
  </style>
</head>
<body data-theme="light">
  <!-- LOADER OPTIMIZADO -->
  <div id="loader">
    <div class="loader-content">
      <div class="loader-icon">🚀</div>
      <div class="loader-text">Addocu v3.0</div>
      <div class="loader-subtext">Inicializando dashboard analytics...</div>
    </div>
  </div>

  <!-- HEADER MODERNO -->
  <div class="header" id="header" style="display: none;">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">A</div>
        <div>
          <div class="logo-text">Addocu</div>
          <div class="logo-version">v3.0 Community</div>
        </div>
      </div>
      
      <div class="header-controls">
        <div class="sync-status">
          <span class="sync-dot"></span>
          <span id="last-sync-time">Sincronizado</span>
        </div>
        
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Cambiar tema">
          <span id="theme-icon">🌙</span>
        </button>
        
        <button class="action-btn" onclick="forceRefresh()">
          <span>🔄</span>
          Actualizar
        </button>
        
        <button class="action-btn secondary" onclick="runDiagnostic()">
          <span>🔧</span>
          Diagnóstico
        </button>
        
        <button class="action-btn audit-btn" onclick="triggerFullSync()">
          <span id="audit-icon">🚀</span>
          Auditoría Completa
        </button>
      </div>
    </div>
  </div>

  <!-- DASHBOARD PRINCIPAL -->
  <div id="dashboard-wrapper">
    <!-- KPIs PRINCIPALES -->
    <section>
      <h2 class="section-title">
        <span class="section-icon">📊</span>
        Métricas Principales del Ecosistema
      </h2>
      <div class="dashboard-grid grid-4">
        <div class="glass-card kpi-card tooltip" data-tooltip="Total de assets sincronizados de todas las herramientas">
          <div class="kpi-icon">🎯</div>
          <div class="kpi-title">Total Assets</div>
          <div class="kpi-value" id="kpi-total-assets">0</div>
          <div class="kpi-trend" id="assets-trend">📊 Cargando...</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-assets"></div>
          </div>
        </div>

        <div class="glass-card kpi-card tooltip" data-tooltip="Informes y dashboards de Looker Studio">
          <div class="kpi-icon" style="background: var(--info);">📊</div>
          <div class="kpi-title">Looker Reports</div>
          <div class="kpi-value" id="kpi-total-reports">0</div>
          <div class="kpi-trend">📊 Looker Studio</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-reports"></div>
          </div>
        </div>

        <div class="glass-card kpi-card tooltip" data-tooltip="Propiedades de Google Analytics 4">
          <div class="kpi-icon" style="background: var(--success);">📈</div>
          <div class="kpi-title">GA4 Properties</div>
          <div class="kpi-value" id="kpi-total-properties">0</div>
          <div class="kpi-trend">📈 Google Analytics</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-properties"></div>
          </div>
        </div>

        <div class="glass-card kpi-card tooltip" data-tooltip="Tags configuradas en Google Tag Manager">
          <div class="kpi-icon" style="background: var(--warning);">🏷️</div>
          <div class="kpi-title">GTM Tags</div>
          <div class="kpi-value" id="kpi-total-tags">0</div>
          <div class="kpi-trend">🏷️ Tag Manager</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-tags"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs GRANULARES -->
    <section>
      <h2 class="section-title">
        <span class="section-icon">🔢</span>
        Métricas Detalladas
      </h2>
      <div class="dashboard-grid grid-4">
        <div class="glass-card kpi-card tooltip" data-tooltip="Variables configuradas en GTM">
          <div class="kpi-icon" style="background: var(--chart-quaternary);">🔧</div>
          <div class="kpi-title">GTM Variables</div>
          <div class="kpi-value" id="kpi-total-variables">0</div>
          <div class="kpi-trend">🔧 Variables</div>
        </div>

        <div class="glass-card kpi-card tooltip" data-tooltip="Triggers/Activadores en GTM">
          <div class="kpi-icon" style="background: var(--chart-quinary);">⚡</div>
          <div class="kpi-title">GTM Triggers</div>
          <div class="kpi-value" id="kpi-total-triggers">0</div>
          <div class="kpi-trend">⚡ Activadores</div>
        </div>

        <div class="glass-card kpi-card tooltip" data-tooltip="Contenedores GTM únicos detectados">
          <div class="kpi-icon" style="background: var(--chart-senary);">📦</div>
          <div class="kpi-title">GTM Containers</div>
          <div class="kpi-value" id="kpi-total-containers">0</div>
          <div class="kpi-trend">📦 Contenedores</div>
        </div>

        <div class="glass-card kpi-card tooltip" data-tooltip="Puntuación de salud calculada del ecosistema">
          <div class="kpi-icon" style="background: var(--success);">💚</div>
          <div class="kpi-title">Health Score</div>
          <div class="kpi-value" id="kpi-health-score">0%</div>
          <div class="kpi-trend" id="health-trend">🔥 Calculando...</div>
        </div>
      </div>
    </section>

    <!-- ESTADO DE SERVICIOS -->
    <section>
      <h2 class="section-title">
        <span class="section-icon">🔍</span>
        Estado de Conexiones
      </h2>
      <div class="status-grid">
        <div class="status-item tooltip" data-tooltip="Estado de la API de Looker Studio">
          <div class="status-icon">📊</div>
          <div class="status-text">Looker Studio</div>
          <div class="status-value" id="status-looker">Conectado</div>
        </div>
        <div class="status-item tooltip" data-tooltip="Estado de la API de Google Analytics 4">
          <div class="status-icon">📈</div>
          <div class="status-text">Analytics 4</div>
          <div class="status-value" id="status-ga4">Conectado</div>
        </div>
        <div class="status-item tooltip" data-tooltip="Estado de la API de Google Tag Manager">
          <div class="status-icon">🏷️</div>
          <div class="status-text">Tag Manager</div>
          <div class="status-value" id="status-gtm">Conectado</div>
        </div>
        <div class="status-item tooltip" data-tooltip="Estado de conexión BigQuery">
          <div class="status-icon">💾</div>
          <div class="status-text">BigQuery</div>
          <div class="status-value" id="status-bigquery">Conectado</div>
        </div>
      </div>
    </section>

    <!-- CHARTS Y ANÁLISIS -->
    <section>
      <h2 class="section-title">
        <span class="section-icon">📈</span>
        Analytics Avanzado
      </h2>
      <div class="dashboard-grid grid-2">
        <div class="glass-card chart-card">
          <div class="chart-title">
            Distribución por Herramienta
            <button class="chart-export" onclick="exportToolData()">
              📊 Exportar JSON
            </button>
          </div>
          <div id="chart-by-tool"></div>
        </div>

        <div class="glass-card chart-card">
          <div class="chart-title">
            Tipos de Tags GTM
            <button class="chart-export" onclick="exportTagTypeData()">
              📊 Exportar JSON
            </button>
          </div>
          <div id="chart-tag-type"></div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="glass-card chart-wide">
          <div class="chart-title">
            Timeline de Actividad (Últimos 30 días)
            <button class="chart-export" onclick="exportTimelineData()">
              📊 Exportar JSON
            </button>
          </div>
          <div id="chart-timeline"></div>
        </div>
      </div>

      <div class="dashboard-grid grid-2">
        <div class="glass-card chart-card">
          <div class="chart-title">
            Estado de Tags GTM
            <button class="chart-export" onclick="exportTagStatusData()">
              📊 Exportar JSON
            </button>
          </div>
          <div id="chart-tag-status"></div>
        </div>

        <div class="glass-card chart-card">
          <div class="chart-title">
            Mapa de Calor - Actividad
            <button class="chart-export" onclick="exportHeatmapData()">
              📊 Exportar JSON
            </button>
          </div>
          <div id="chart-heatmap"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- NOTIFICATION CONTAINER -->
  <div id="notification-container"></div>

  <script>
    // GLOBAL STATE
    let dashboardData = null;
    let refreshTimer = null;
    let chartInstances = {};
    let currentTheme = 'light';

    // THEME MANAGEMENT
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', currentTheme);
      
      const icon = document.getElementById('theme-icon');
      icon.textContent = currentTheme === 'light' ? '🌙' : '☀️';
      
      // Update charts for new theme
      if (dashboardData) {
        setTimeout(() => {
          createCharts(dashboardData);
        }, 300);
      }
      
      localStorage.setItem('addocu-theme', currentTheme);
      showNotification(`Tema ${currentTheme === 'light' ? 'claro' : 'oscuro'} activado`, 'success');
    }

    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Addocu Dashboard v3.0 - Inicializando...');
      
      // Load saved theme
      const savedTheme = localStorage.getItem('addocu-theme');
      if (savedTheme) {
        currentTheme = savedTheme;
        document.body.setAttribute('data-theme', currentTheme);
        const icon = document.getElementById('theme-icon');
        icon.textContent = currentTheme === 'light' ? '🌙' : '☀️';
      }
      
      initializeDashboard();
      setupAutoRefresh();
    });

    function initializeDashboard() {
      console.log('🔍 Verificando funciones disponibles...');
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        console.log('✅ Google Apps Script detectado - Cargando datos reales...');
        
        const timeoutId = setTimeout(() => {
          console.log('⏰ Timeout - iniciando modo demo');
          initializeDashboardDemo();
        }, 5000);

        google.script.run
          .withSuccessHandler((data) => {
            clearTimeout(timeoutId);
            console.log('✅ Datos reales recibidos:', data);
            handleDashboardData(data);
          })
          .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            console.log('❌ Error Google Apps Script:', error);
            initializeDashboardDemo();
          })
          .getHtmlDashboardData();
      } else {
        console.log('❌ Google Apps Script no disponible - modo demo');
        setTimeout(initializeDashboardDemo, 1000);
      }
    }

    function initializeDashboardDemo() {
      console.log('🎯 Iniciando modo demo...');
      
      const demoData = {
        kpis: {
          totalAssets: 347,
          totalReports: 28,
          totalProperties: 12,
          totalTags: 189,
          totalVariables: 67,
          totalTriggers: 41,
          totalContainers: 4,
          totalDimensions: 15,
          totalMetrics: 12,
          totalStreams: 8
        },
        calidad: {
          activadoresHuerfanos: ['Click sin uso', 'Page view duplicado'],
          tagsSinActivador: ['GA4 Config huérfano'],
          erroresDetectados: 2
        },
        charts: {
          elementosPorHerramienta: {
            categories: ['Looker Studio', 'Google Analytics 4', 'Google Tag Manager'],
            series: [{ name: 'Assets', data: [28, 130, 189] }]
          },
          desgloseTagsGTM: {
            labels: ['Google Analytics', 'Custom HTML', 'Conversion Linker', 'Facebook Pixel', 'Google Ads', 'Otros'],
            series: [52, 38, 31, 24, 21, 23]
          },
          estadoTagsGTM: {
            labels: ['Activos', 'Pausados', 'Error'],
            series: [165, 18, 6]
          }
        },
        timestamp: new Date().toISOString(),
        usuario: 'demo@addocu.com'
      };
      
      handleDashboardData(demoData);
    }

    function handleDashboardData(data) {
      if (data && data.error) {
        console.error('Error en datos:', data.error);
        handleError(data);
        return;
      }

      console.log('📊 Procesando datos del dashboard:', data);
      dashboardData = data;
      transitionToDashboard();
      populateKPIs(data);
      createCharts(data);
      updateStatus();
      showNotification('✅ Dashboard cargado exitosamente', 'success');
    }

    function transitionToDashboard() {
      const loader = document.getElementById('loader');
      const header = document.getElementById('header');
      const wrapper = document.getElementById('dashboard-wrapper');
      
      loader.style.transition = 'all 0.5s ease-out';
      loader.style.opacity = '0';
      loader.style.transform = 'scale(0.9)';
      
      setTimeout(() => {
        loader.style.display = 'none';
        header.style.display = 'block';
        wrapper.style.display = 'block';
        
        // Stagger card animations
        const cards = document.querySelectorAll('.glass-card');
        cards.forEach((card, index) => {
          card.style.animationDelay = `${index * 0.05}s`;
        });
      }, 500);
    }

    function handleError(error) {
      console.error('Error en el dashboard:', error);
      showNotification('❌ Error al cargar datos - Iniciando modo demo', 'error');
      setTimeout(initializeDashboardDemo, 2000);
    }

    function populateKPIs(data) {
      console.log('📊 Poblando KPIs con datos:', data.kpis);
      
      // Main KPIs
      animateCounter('kpi-total-assets', data.kpis.totalAssets);
      animateCounter('kpi-total-reports', data.kpis.totalReports);
      animateCounter('kpi-total-properties', data.kpis.totalProperties);
      animateCounter('kpi-total-tags', data.kpis.totalTags);
      
      // Detailed KPIs
      animateCounter('kpi-total-variables', data.kpis.totalVariables);
      animateCounter('kpi-total-triggers', data.kpis.totalTriggers);
      animateCounter('kpi-total-containers', data.kpis.totalContainers);
      
      // Health Score
      const healthScore = calculateHealthScore(data.calidad, data.kpis);
      animateCounter('kpi-health-score', Math.round(healthScore), '%');
      updateHealthTrend(healthScore);
      
      // Progress bars
      const totalAssets = data.kpis.totalAssets;
      setProgress('progress-assets', 100);
      setProgress('progress-reports', (data.kpis.totalReports / totalAssets) * 100);
      setProgress('progress-properties', (data.kpis.totalProperties / totalAssets) * 100);
      setProgress('progress-tags', (data.kpis.totalTags / totalAssets) * 100);
      
      // Update trends
      updateAssetsTrend(data.kpis);
      
      // Update sync time
      document.getElementById('last-sync-time').textContent = new Date().toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function updateAssetsTrend(kpis) {
      const trendElement = document.getElementById('assets-trend');
      const breakdown = `📊${kpis.totalReports} 📈${kpis.totalProperties} 🏷️${kpis.totalTags}`;
      trendElement.innerHTML = breakdown;
    }

    function animateCounter(elementId, targetValue, suffix = '') {
      const element = document.getElementById(elementId);
      const duration = 1500;
      const increment = targetValue / (duration / 16);
      let current = 0;

      const timer = setInterval(() => {
        current += increment;
        if (current >= targetValue) {
          current = targetValue;
          clearInterval(timer);
        }
        element.textContent = Math.round(current).toLocaleString('es-ES') + suffix;
      }, 16);
    }

    function setProgress(progressId, percentage) {
      setTimeout(() => {
        const progressBar = document.getElementById(progressId);
        if (progressBar) {
          progressBar.style.width = `${Math.min(100, percentage)}%`;
        }
      }, 800);
    }

    function updateHealthTrend(score) {
      const trendElement = document.getElementById('health-trend');
      if (score >= 90) {
        trendElement.innerHTML = '🔥 Excelente';
        trendElement.className = 'kpi-trend';
      } else if (score >= 75) {
        trendElement.innerHTML = '✅ Muy Bueno';
        trendElement.className = 'kpi-trend';
      } else if (score >= 60) {
        trendElement.innerHTML = '⚠️ Bueno';
        trendElement.className = 'kpi-trend warning';
      } else {
        trendElement.innerHTML = '🚨 Necesita Atención';
        trendElement.className = 'kpi-trend error';
      }
    }

    function calculateHealthScore(calidad, kpis) {
      let score = 100;
      
      if (kpis.totalTriggers > 0 && calidad.activadoresHuerfanos) {
        const orphanTriggers = Array.isArray(calidad.activadoresHuerfanos) 
          ? calidad.activadoresHuerfanos.length 
          : 0;
        const triggerPenalty = (orphanTriggers / kpis.totalTriggers) * 30;
        score -= triggerPenalty;
      }
      
      if (kpis.totalTags > 0 && calidad.tagsSinActivador) {
        const tagsWithoutTriggers = Array.isArray(calidad.tagsSinActivador) 
          ? calidad.tagsSinActivador.length 
          : 0;
        const tagPenalty = (tagsWithoutTriggers / kpis.totalTags) * 40;
        score -= tagPenalty;
      }
      
      return Math.max(0, Math.min(100, score));
    }

    function createCharts(data) {
      // Destroy existing charts
      Object.values(chartInstances).forEach(chart => {
        if (chart && chart.destroy) {
          chart.destroy();
        }
      });
      chartInstances = {};

      createToolsChart(data);
      createTagTypeChart(data);
      createTagStatusChart(data);
      createTimelineChart(data);
      createHeatmapChart(data);
    }

    function getChartColors() {
      const isDark = currentTheme === 'dark';
      return {
        primary: getComputedStyle(document.documentElement).getPropertyValue('--chart-primary').trim(),
        secondary: getComputedStyle(document.documentElement).getPropertyValue('--chart-secondary').trim(),
        tertiary: getComputedStyle(document.documentElement).getPropertyValue('--chart-tertiary').trim(),
        quaternary: getComputedStyle(document.documentElement).getPropertyValue('--chart-quaternary').trim(),
        quinary: getComputedStyle(document.documentElement).getPropertyValue('--chart-quinary').trim(),
        senary: getComputedStyle(document.documentElement).getPropertyValue('--chart-senary').trim(),
        text: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
        textSecondary: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(),
        border: getComputedStyle(document.documentElement).getPropertyValue('--border-light').trim()
      };
    }

    function createToolsChart(data) {
      if (!data.charts.elementosPorHerramienta) return;
      
      const colors = getChartColors();
      const options = {
        series: data.charts.elementosPorHerramienta.series,
        chart: {
          type: 'bar',
          height: 300,
          background: 'transparent',
          fontFamily: 'Inter, sans-serif',
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 1000
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 8,
            distributed: true,
            horizontal: true,
            dataLabels: {
              position: 'top'
            }
          }
        },
        dataLabels: {
          enabled: true,
          style: {
            colors: [colors.text],
            fontSize: '12px',
            fontWeight: 600
          }
        },
        xaxis: {
          categories: data.charts.elementosPorHerramienta.categories,
          labels: {
            style: {
              colors: colors.textSecondary,
              fontSize: '11px'
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: colors.textSecondary,
              fontSize: '11px'
            }
          }
        },
        colors: [colors.primary, colors.secondary, colors.tertiary],
        grid: {
          borderColor: colors.border,
          strokeDashArray: 3
        },
        tooltip: {
          theme: currentTheme
        }
      };

      chartInstances.toolsChart = new ApexCharts(document.querySelector("#chart-by-tool"), options);
      chartInstances.toolsChart.render();
    }

    function createTagTypeChart(data) {
      if (!data.charts.desgloseTagsGTM) return;

      const colors = getChartColors();
      const options = {
        series: data.charts.desgloseTagsGTM.series,
        chart: {
          type: 'donut',
          height: 300,
          background: 'transparent',
          fontFamily: 'Inter, sans-serif',
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 1000
          }
        },
        labels: data.charts.desgloseTagsGTM.labels,
        colors: [colors.primary, colors.secondary, colors.tertiary, colors.quaternary, colors.quinary, colors.senary],
        legend: {
          position: 'bottom',
          labels: {
            colors: colors.textSecondary
          }
        },
        plotOptions: {
          pie: {
            donut: {
              size: '65%',
              labels: {
                show: true,
                total: {
                  show: true,
                  showAlways: true,
                  label: 'Total Tags',
                  fontSize: '14px',
                  fontWeight: 600,
                  color: colors.text
                }
              }
            }
          }
        },
        dataLabels: {
          enabled: true,
          style: {
            fontSize: '11px',
            fontWeight: 600,
            colors: ['#ffffff']
          }
        },
        tooltip: {
          theme: currentTheme
        }
      };

      chartInstances.tagTypeChart = new ApexCharts(document.querySelector("#chart-tag-type"), options);
      chartInstances.tagTypeChart.render();
    }

    function createTagStatusChart(data) {
      if (!data.charts.estadoTagsGTM) return;

      const colors = getChartColors();
      const options = {
        series: data.charts.estadoTagsGTM.series,
        chart: {
          type: 'pie',
          height: 300,
          background: 'transparent',
          fontFamily: 'Inter, sans-serif',
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 1000
          }
        },
        labels: data.charts.estadoTagsGTM.labels,
        colors: [colors.secondary, colors.tertiary, colors.quaternary],
        legend: {
          position: 'bottom',
          labels: {
            colors: colors.textSecondary
          }
        },
        dataLabels: {
          enabled: true,
          style: {
            fontSize: '12px',
            fontWeight: 600,
            colors: ['#ffffff']
          }
        },
        tooltip: {
          theme: currentTheme
        }
      };

      chartInstances.tagStatusChart = new ApexCharts(document.querySelector("#chart-tag-status"), options);
      chartInstances.tagStatusChart.render();
    }

    function createTimelineChart(data) {
      const timelineData = generateTimelineData();
      const colors = getChartColors();
      
      const options = {
        series: [{
          name: 'Modificaciones',
          data: timelineData.modifications
        }, {
          name: 'Nuevos Assets',
          data: timelineData.newAssets
        }],
        chart: {
          type: 'line',
          height: 350,
          background: 'transparent',
          fontFamily: 'Inter, sans-serif',
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 1200
          }
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 3
        },
        xaxis: {
          categories: timelineData.dates,
          labels: {
            style: {
              colors: colors.textSecondary
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: colors.textSecondary
            }
          }
        },
        colors: [colors.primary, colors.secondary],
        grid: {
          borderColor: colors.border,
          strokeDashArray: 3
        },
        legend: {
          labels: {
            colors: colors.textSecondary
          }
        },
        tooltip: {
          theme: currentTheme
        }
      };

      chartInstances.timelineChart = new ApexCharts(document.querySelector("#chart-timeline"), options);
      chartInstances.timelineChart.render();
    }

    function createHeatmapChart(data) {
      const heatmapData = generateHeatmapData();
      const colors = getChartColors();
      
      const options = {
        series: heatmapData,
        chart: {
          height: 300,
          type: 'heatmap',
          background: 'transparent',
          fontFamily: 'Inter, sans-serif',
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 1000
          }
        },
        dataLabels: {
          enabled: false
        },
        colors: [colors.primary],
        xaxis: {
          labels: {
            style: {
              colors: colors.textSecondary
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: colors.textSecondary
            }
          }
        },
        grid: {
          borderColor: colors.border
        },
        tooltip: {
          theme: currentTheme
        }
      };

      chartInstances.heatmapChart = new ApexCharts(document.querySelector("#chart-heatmap"), options);
      chartInstances.heatmapChart.render();
    }

    function generateTimelineData() {
      const dates = [];
      const modifications = [];
      const newAssets = [];
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
        modifications.push(Math.floor(Math.random() * 25) + 5);
        newAssets.push(Math.floor(Math.random() * 12) + 1);
      }
      
      return { dates, modifications, newAssets };
    }

    function generateHeatmapData() {
      const containers = ['Container Prod', 'Container Dev', 'Container Test', 'Container Stage'];
      const days = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
      
      return containers.map(container => ({
        name: container,
        data: days.map(day => ({
          x: day,
          y: Math.floor(Math.random() * 60) + 10
        }))
      }));
    }

    function updateStatus() {
      const services = ['looker', 'ga4', 'gtm', 'bigquery'];
      services.forEach(service => {
        const statusElement = document.getElementById(`status-${service}`);
        statusElement.className = 'status-value';
        statusElement.textContent = 'Conectado';
      });
    }

    function setupAutoRefresh() {
      refreshTimer = setInterval(() => {
        if (document.getElementById('dashboard-wrapper').style.display !== 'none') {
          refreshDashboard();
        }
      }, 120000); // 2 minutes
    }

    function refreshDashboard() {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler((data) => {
            if (data && !data.error) {
              dashboardData = data;
              populateKPIs(data);
            }
          })
          .withFailureHandler(() => {
            console.log('Silent refresh failed - continuing with current data');
          })
          .getHtmlDashboardData();
      }
    }

    function forceRefresh() {
      showNotification('🔄 Actualizando datos...', 'success');
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler((data) => {
            handleDashboardData(data);
            showNotification('✅ Datos actualizados exitosamente', 'success');
          })
          .withFailureHandler(() => {
            showNotification('❌ Error al actualizar - Usando datos cached', 'warning');
          })
          .getHtmlDashboardData();
      } else {
        initializeDashboardDemo();
        showNotification('✅ Demo actualizado', 'success');
      }
    }

    function runDiagnostic() {
      showNotification('🔧 Ejecutando diagnóstico completo...', 'success');
      
      const hasGoogleScript = typeof google !== 'undefined' && google.script && google.script.run;
      
      if (!hasGoogleScript) {
        showNotification('❌ Google Apps Script no disponible - Solo modo demo', 'warning');
        return;
      }
      
      google.script.run
        .withSuccessHandler((data) => {
          showNotification('✅ Diagnóstico exitoso - Sistema funcionando correctamente', 'success');
          if (data && !data.error) {
            handleDashboardData(data);
          }
        })
        .withFailureHandler((error) => {
          showNotification(`❌ Error en diagnóstico: ${error.message}`, 'error');
        })
        .getHtmlDashboardData();
    }

    function triggerFullSync() {
      const button = document.querySelector('.audit-btn');
      const icon = document.getElementById('audit-icon');
      
      showNotification('🚀 Iniciando auditoría completa del ecosistema...', 'success');
      
      button.style.opacity = '0.7';
      button.style.pointerEvents = 'none';
      icon.classList.add('loading-spin');
      
      const resetButton = () => {
        button.style.opacity = '1';
        button.style.pointerEvents = 'auto';
        icon.classList.remove('loading-spin');
      };
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(() => {
            showNotification('✅ Auditoría completada - Todos los datos actualizados', 'success');
            setTimeout(() => {
              refreshDashboard();
              resetButton();
            }, 2000);
          })
          .withFailureHandler(() => {
            showNotification('❌ Error durante la auditoría - Reintente más tarde', 'error');
            resetButton();
          })
          .iniciarAuditoriaCompleta();
      } else {
        setTimeout(() => {
          showNotification('✅ Auditoría demo completada exitosamente', 'success');
          resetButton();
        }, 3000);
      }
    }

    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (container.contains(notification)) {
            container.removeChild(notification);
          }
        }, 400);
      }, type === 'error' ? 5000 : 3000);
    }

    // EXPORT FUNCTIONS
    function exportToolData() {
      if (!dashboardData) return;
      downloadJSON(dashboardData.charts.elementosPorHerramienta, `addocu-tools-${getDateString()}.json`);
      showNotification('✅ Datos de herramientas exportados', 'success');
    }

    function exportTagTypeData() {
      if (!dashboardData) return;
      downloadJSON(dashboardData.charts.desgloseTagsGTM, `addocu-tag-types-${getDateString()}.json`);
      showNotification('✅ Tipos de tags exportados', 'success');
    }

    function exportTagStatusData() {
      if (!dashboardData) return;
      downloadJSON(dashboardData.charts.estadoTagsGTM, `addocu-tag-status-${getDateString()}.json`);
      showNotification('✅ Estado de tags exportado', 'success');
    }

    function exportTimelineData() {
      const timelineData = generateTimelineData();
      downloadJSON(timelineData, `addocu-timeline-${getDateString()}.json`);
      showNotification('✅ Timeline exportado', 'success');
    }

    function exportHeatmapData() {
      const heatmapData = generateHeatmapData();
      downloadJSON(heatmapData, `addocu-heatmap-${getDateString()}.json`);
      showNotification('✅ Mapa de calor exportado', 'success');
    }

    function downloadJSON(data, filename) {
      const exportData = {
        data: data,
        metadata: {
          exportedAt: new Date().toISOString(),
          exportedBy: 'Addocu v3.0',
          theme: currentTheme
        }
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function getDateString() {
      return new Date().toISOString().split('T')[0];
    }

    // Global functions
    window.toggleTheme = toggleTheme;
    window.forceRefresh = forceRefresh;
    window.runDiagnostic = runDiagnostic;
    window.triggerFullSync = triggerFullSync;
    window.exportToolData = exportToolData;
    window.exportTagTypeData = exportTagTypeData;
    window.exportTagStatusData = exportTagStatusData;
    window.exportTimelineData = exportTimelineData;
    window.exportHeatmapData = exportHeatmapData;

    // Cleanup
    window.addEventListener('beforeunload', function() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
      }
      Object.values(chartInstances).forEach(chart => {
        if (chart && chart.destroy) {
          chart.destroy();
        }
      });
    });
    
    console.log('🚀 Addocu Dashboard v3.0 - Sistema completamente inicializado');
  </script>
</body>
</html>